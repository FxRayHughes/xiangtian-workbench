<!DOCTYPE html>
<html lang="en" xmlns="">
<head>
  <meta charset="UTF-8">
  <title>下载助手</title>
  <script  src="../../ext/vue/vue.js"></script>
  <script  src="../../ext/vue/antd.min.js"></script>
  <link rel="stylesheet" href="../../ext/vue/antd.min.css"/>

</head>
<body>

<div id="appVue">
  <template>
    <div class="toggle">
      <a-tabs default-active-key='1' @change="callback">
        <a-tab-pane key="1" >
        <span slot="tab">
           <a-badge :count="count" id="tag">
             <a href="#" class="head-example"></a>
           </a-badge>
        下载中
      </span>
          <div id="downloadIng" v-for="(list,index) in lists" v-bind:key="index"  @contextmenu="menuIng(index)" @click="change(index)"  :class="{active : active === index,
         clickActive:clickActive===index}"
               @mouseover="mouseOver(index)"
               @mouseleave="mouseLeave">
            <div style="margin-top: 0;width: 100%;height: 55px;">
              <div style="width: 34px;height: 40px;position: absolute;margin-top: 8px;margin-left: 5px;" >
                <a-icon type="file-text" style="fontSize:30px"></a-icon>
              </div>

              <div>
                <a-modal v-model="visibleIng" title="删除下载任务" ok-text="确认" cancel-text="取消" @ok="hideModal()">
                  <p>文件正在下载中，确认删除</p>
                </a-modal>
              </div>

              <div v-if="list.status === 'progressing'" >
                <div v-if="list.loadstate" >
                  <a-button style="position: absolute;margin-left: 270px;margin-top: 14px" type="link" @click="resume(index)" >
                     开始
                  </a-button>
                </div>
                <div v-else>
                  <a-button style="position: absolute;margin-left: 270px;margin-top: 14px" type="link" @click="stop(index)">
                    暂停
                  </a-button>
                </div>
              </div>
<!--           <div>-->
<!--            <div style="margin-left: 50px;font-size: 15px;font-weight: bold ;">{{list.title}}</div>-->
<!--            <div style="margin-left: 50px;font-size: 12px;width: 150px;">{{list.received}}  MB  /  {{list.total}}  MB</div>-->
<!--            <div style="position: absolute;margin-left: 220px;width: 50px;margin-top: -20px" >{{list.realdata}}/MB</div>-->
<!--           </div>-->
<!--            <a-progress style="position: absolute;width: 95%;padding-left: 50px;margin-top: -6px"  :percent="list.progressnuw"></a-progress>-->
<!--            -->

<!--              <div v-if="list.status === ' progressing ' ">-->
<!--              <div>-->
<!--                <div style="margin-left: 50px;font-size: 15px;font-weight: bold ;">{{list.title}}</div>-->
<!--                <div style="margin-left: 50px;font-size: 12px;width: 150px;">{{list.received}}  MB  /  {{list.total}}  MB</div>-->
<!--                <div style="position: absolute;margin-left: 220px;width: 50px;margin-top: -20px" >{{list.realdata}}/MB</div>-->
<!--              </div>-->
<!--              <a-progress style="position: absolute;width: 95%;padding-left: 50px;margin-top: -6px"  :percent="list.progressnuw"></a-progress>-->
<!--              </div>-->
              <div v-if="list.status === 'start'">
                 <div style="margin-left: 50px;font-size: 15px;font-weight: bold ;">{{list.title}}</div>
                 <div style="margin-left: 50px;font-size: 12px;width: 150px;">{{list.total}}  MB</div>
                 <div style="position: absolute;margin-left: 200px;width: 100px;margin-top: -25px">文件等待下载中</div>
             </div>
              <div v-else >
                <div>
              <div style="margin-left: 50px;font-size: 15px;font-weight: bold ;">{{list.title}}</div>
              <div style="margin-left: 50px;font-size: 12px;width: 150px;">{{list.received}}  MB  /  {{list.total}}  MB</div>
               <div style="position: absolute;margin-left: 220px;width: 50px;margin-top: -20px" >{{list.realdata}}/MB</div>
              </div>
                <a-progress style="position: absolute;width: 95%;padding-left: 50px;margin-top: -6px"  :percent="list.progressnuw"></a-progress>
               </div>
            </div>
          </div>
        </a-tab-pane>

        <a-tab-pane key="2" tab="已完成" force-render>
          <div id="downloadDone" v-for="(doneList,index) in doneLists" v-bind:key="index" @click="change(index)"  @contextmenu="menuDone(index)"  :class="{active : active === index,
         clickActive:clickActive===index}"
               @mouseover="mouseOver(index)"
               @mouseleave="mouseLeave">
            <div style="width: 100%;height: 45px;">
              <div style="width: 34px;height: 40px;position: absolute;margin-top: 8px;margin-left: 5px;" >
                <a-icon type="file-text" style="fontSize:30px"></a-icon>
              </div>
                <div>
                  <a-modal v-model="visible" title="删除下载任务" ok-text="确认" cancel-text="取消" @ok="hideModalDone()">
                    <p>文件下载已完成，确认删除</p>
                    <a-checkbox @change="doneChange">
                      同时删除下载文件
                    </a-checkbox>
                  </a-modal>
                </div>

              <a-button style="position: absolute;margin-left: 200px;margin-top: 5px" type="link" @click="openFileHandler(index)" >
                打开
              </a-button>
                <a-button style="position: absolute;margin-left: 240px;margin-top: 5px" type="link" @click="showFileHandler(index)" >
                  打开文件夹
                </a-button>
              <div style="margin-left: 50px;font-size: 15px;font-weight: bold ;">{{doneList.title}}</div>
              <div style="margin-left: 50px;font-size: 12px;width: 150px;">{{doneList.total}}  MB</div>

            </div>
          </div>
        </a-tab-pane>

<!--        <a-tab-pane key="3" tab="回收站">-->
<!--          <div v-for="(deletelist,index) in deletelists" v-bind:key="index">-->
<!--            <div style="width: 100%;height: 45px;background-color: #8c8c8c">-->
<!--              <div style="margin-left: 50px">{{deletelist.title}}</div>-->
<!--              <div style="margin-left: 50px">{{deletelist.title}}</div>-->
<!--            </div>-->
<!--          </div>-->
<!--        </a-tab-pane>-->
      </a-tabs>
    </div>
  </template>

</div>

<script type="module">

  const { clipboard } = require('electron')
  const { shell } = require('electron')
  const fs = require('fs')
  let {ipcMain} = require('electron')
  let {ipcRenderer} = require('electron')
  const {db} = require('../../js/util/database')


  ipcRenderer.on('menuIngStart', (e,args) => {
    if(appVue.selectIngList.loadstate === true){
      ipcRenderer.send('resumeDownload', appVue.selectIngList.path)
      appVue.selectIngList.loadstate = false
    }else {
      ipcRenderer.send('stopDownload', appVue.selectIngList.path)
      appVue.selectIngList.loadstate = true
    }
  })

  ipcRenderer.on('menuIngUrl', (e) => {
    clipboard.writeText( appVue.selectIngList.url)
    appVue.$message.success('已复制到剪切板');
  })

  ipcRenderer.on('menuIngDelete', (e) => {
    appVue.visibleIng = true;
  })

  ipcRenderer.on('menuDoneOpen', (e) => {
    const {shell} = require('electron')
    shell.openPath(appVue.selectList.path)
  })

  ipcRenderer.on('menuDoneOpenPath', (e) => {
    const {shell} = require('electron')
    shell.showItemInFolder(appVue.selectList.path)
  })

  ipcRenderer.on('menuDoneOpenPage', (e) => {
    // require('../../js/browserUI.js').closeTab(data.id)
  })

  ipcRenderer.on('menuDoneUrl', (e) => {
    clipboard.writeText( appVue.selectList.url)
    appVue.$message.success('已复制到剪切板');
  })

  ipcRenderer.on('menuDoneDelete', (e) => {
    appVue.visible = true;
    appVue.deleconfirm=false
  })

  ipcRenderer.on('download-info', async (event, args) => {

    let simpleName;
    if (args.name.length >= 20) {
      simpleName = args.name.substring(0, 7) + '...' + args.name.substring(args.name.length-6,args.name.length);
    } else (simpleName = args.name)
    if (args.status === 'start') {
      appVue.lists.push({
        id: appVue.id++,
        title: simpleName,
        received: '',
        realdata: '',
        total: ((args.size.total) / 1024 / 1024).toFixed(2),
        progressnuw: 0,
        startTime: args.startTime,
        path: '',
        loadstate: false,
        url: args.url,
        status:args.status,
      })
      appVue.count++
      ipcRenderer.send('willDownload')
      ipcRenderer.send('downloadcount')

    }
     if(args.status ==='cancelled'){
       appVue.lists.splice(appVue.lists.indexOf(args), 1)
       appVue.count--
     }

    if (args.status === 'progressing' && args.path !== '') {
      appVue.lists.forEach(function (item, index, arr) {
        if (item.startTime === args.startTime) {
          item.title = simpleName;
          item.received = ((args.size.received) / 1024 / 1024).toFixed(2);
          item.realdata = ((args.realdata) / 1024 / 1024).toFixed(2);
          item.total = ((args.size.total) / 1024 / 1024).toFixed(2);
          item.progressnuw = Math.round(args.progressnuw);
          item.path = args.path
          item.status = args.status
          if (item.progressnuw === 100) {
            appVue.lists.splice(index, 1)
          }
        }
      })
    }

    if (args.status === 'completed' ) {
          appVue.doneLists.push({
            id: appVue.doneId++,
            title: simpleName,
            total: ((args.size.total) / 1024 / 1024).toFixed(2),
            path: args.path,
            url: args.url,
            startTime: args.startTime
          })
      appVue.$message.success('一个文件已下载完成',0.05);
      shell.beep()
      appVue.count--
      db.download.add({
        title:args.name,
        total:((args.size.total) / 1024 / 1024).toFixed(2),
        path:args.path,
        url:args.url,
        startTime:args.startTime
      })
    }

  })

   let appVue = new Vue({
     el: '#appVue',
     data: {
       count: '0',
       visibleIng: false,
       visible: false,
       lists: [],
       doneLists: [],
       deletelists: [],
       nextTodoId2: 0,
       progressnuw: 0,
       startTime: '',
       pathlist: [],
       loadstate: [],
       id: '0',
       active: '',
       clickActive: '',
       selectList: [],
       selectIngList: [],
       url: '',
       doneId: '0',
       deleconfirm: false,
     },
     created() {
       db.download.toArray().then(dblist => {
         for (let i = 0; i <= dblist.length; i++) {
           let simpleName;
           if (dblist[i].title.length >= 20) {
             simpleName = dblist[i].title.substring(0, 7) + '...' + dblist[i].title.substring(dblist[i].title.length - 6, dblist[i].title.length);
           } else (simpleName = dblist[i].title)
           appVue.doneLists.push({
             id: appVue.doneId++,
             title: simpleName,
             total: dblist[i].total,
             path: dblist[i].path,
             url: dblist[i].url,
             startTime: dblist[i].startTime,
           })
         }
       })
     },
     methods: {
       menuIng(index) {
         ipcRenderer.send('showMenuIng', this.lists[index].loadstate)
         this.selectIngList = this.lists[index]
         this.active = index;
       },
       menuDone(index) {
         ipcRenderer.send('showMenuDone')
         this.selectList = this.doneLists[index]
         this.active = index;
       },
       mouseOver(index) {
         this.clickActive = index;
       },
       mouseLeave() {
         this.clickActive = '';
       },
       change(index) {
         this.active = index;
       },

       hideModal() {
         ipcRenderer.send('deleteDownload', this.selectIngList.path)
         this.lists.splice(this.lists.indexOf(this.selectIngList), 1)
         this.visibleIng = false;
         this.count--
       },

       doneChange(e) {
         if (e.target.checked === true) {
           this.deleconfirm = true
         }
         if (e.target.checked === false) {
           this.deleconfirm = false
         }
       },
       callback(key) {
       },

       hideModalDone() {
         db.download.delete(appVue.selectList.startTime)
         if (this.deleconfirm === true) {
           const f = this.selectList.path;
           fs.exists(f, function (flag) {
             if (flag) {
               fs.unlinkSync(appVue.selectList.path)
               appVue.doneLists.splice(appVue.doneLists.indexOf(appVue.selectList), 1)
               appVue.visible = false;
             } else {
               appVue.doneLists.splice(appVue.doneLists.indexOf(appVue.selectList), 1)
               appVue.visible = false;
             }
           })
         }
         if (this.deleconfirm === false) {
           this.doneLists.splice(this.doneLists.indexOf(this.selectList), 1)
           this.visible = false;
         }
       },
       resume(index) {
         ipcRenderer.send('resumeDownload', this.lists[index].path)
         this.lists[index].loadstate = false
       },
       stop(index) {
         ipcRenderer.send('stopDownload', this.lists[index].path)
         this.lists[index].loadstate = true
       },

       openFileHandler(index) {
         const {shell} = require('electron')
         shell.openPath(this.doneLists[index].path)
       },

       showFileHandler(index) {
         const {shell} = require('electron')
         const f = this.doneLists[index].path;
         fs.exists(f, function (flag) {
           if (flag) {
             shell.showItemInFolder(appVue.doneLists[index].path)
           } else {
             appVue.$message.success('文件已被删除或位置被移动',1)
           }
         })
       },
     }
   })
</script>

</body>

<style>
#tag{
  position: absolute;
  margin-left: 60px;
  margin-top: 10px;
}
.active {
  background: #e6e6e6;
}
.clickActive{
  background: #e8f2ff;
}
</style>

</html>
