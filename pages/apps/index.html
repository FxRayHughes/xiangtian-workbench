<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>应用中心</title>
		<script src="../../ext/vue/vue.js"></script>
		<script src="../../ext/vue/antd.min.js"></script>
		<link rel="stylesheet" href="../../ext/vue/antd.min.css" />
		<link rel="icon" type="image/svg+xml" href="../../icons/apps.svg" />
		<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-eval' 'unsafe-inline'" />
	</head>
	<body>
		<script>
			Vue.use(antd);
		</script>
		<div id="appVue">
			<div>
				<a-layout style="height: 100vh;" :trigger="null">
					<a-layout-sider style="background-color: white;">
						<sidenav @gettab="settab" />
					</a-layout-sider>
					<a-layout v-show="current==='myapp'">
						<a-layout-header style="background: #fff; padding: 0">
							<a-page-header style="border: 1px solid rgb(235, 237, 240)" title="我的应用"
								sub-title="管理我的应用，这里的应用可以随时添加到左侧栏，或者基于应用创建标签，不会因标签被关闭而丢失。" />
						</a-layout-header>
						<a-layout-content>
							<div style="padding: 20px;text-align: left;padding: 10px;margin:20px">
								<!-- <div style="text-align: center;margin:20px">
									<search />
								</div> -->
								<div>
									<a-card title="现有应用">



										<a slot="extra" @click="showModal">添加应用</a>


										<a-card-grid v-for="(app, index) in myApps" class="app" style="cursor: pointer;"
											@click="addTask(app)">
											<a-avatar shape="square" :size="64" :src="app.icon"
												style="margin-bottom: 10px;"></a-avatar>
											<a-card-meta :title="app.name">
												<template slot="description">
													{{ app.summary }}
												</template>

											</a-card-meta>

										</a-card-grid>

										<a-empty v-if="myApps.length==0" description="还未添加任何应用，点击添加应用选择应用">

											<a-button type="primary" @click="showModal">
												添加应用
											</a-button>

										</a-empty>
										<a-card-grid v-else class="app" style="cursor: pointer;" @click="showModal">
											<a-avatar shape="square" :size="64" icon="plus"
												style="margin-bottom: 10px;"></a-avatar>
											<a-card-meta title="添加">
												<template slot="description">
													自行添加应用
												</template>
											</a-card-meta>
										</a-card-grid>
									</a-card>

								</div>
							</div>
						</a-layout-content>
						<a-layout-footer style="text-align: center">想天科技版权所有 ©2014-2021 </a-layout-footer>
					</a-layout>
					<a-layout v-show="current==='appstore'">
						<a-layout-header style="background: #fff; padding: 0">
							<a-page-header style="border: 1px solid rgb(235, 237, 240)" title="应用中心"
								:sub-title="'这里可以查看全部的应用，应用列表更新于'+appUpdateTime+'。'" />
						</a-layout-header>
						<a-layout-content>
							<div style="padding: 20px;text-align: left;padding: 10px;margin:20px">
								<template>
									<div style="width: 100% ;background: white;
    border-radius: 8px;
    padding: 20px;
    min-height: 800px;">
								
										<a-tabs default-active-key="productive" tab-position="left"
											:style="{ height: '100%' }">
											<a-tab-pane v-for="(type, indexType) in allApps" :key="type.name"
												:tab="type.title">
								
												<a-card :title="type.title" style="padding: 10px;">
													<a-card-grid style="width: 140px;cursor: pointer;"
														v-for="(app, indexApp) in type.apps" class="app"
														@click="addApp(app)">
														<a-avatar shape="square" :size="64" :src="app.icon"
															style="margin-bottom: 10px;"></a-avatar>
														<a-card-meta :title="app.name">
															<template slot="description">
																{{ app.summary }}
															</template>
														</a-card-meta>
													</a-card-grid>
											</a-tab-pane>
											</a-card>
										</a-tabs>
									</div>
								</template>
							</div>
						</a-layout-content>
						<a-layout-footer style="text-align: center">
							
							 <br>
							想天科技版权所有 ©2014-2021 </a-layout-footer>
					</a-layout>
				</a-layout>
			</div>

			<template>
				<div>
					<a-modal v-model="visible" title="添加应用" :footer="null" :width="800">
						<template>
							<a-tabs default-active-key="1" tab-position="top">
								<a-tab-pane key="1">
									<span slot="tab">
										<a-icon type="appstore"></a-icon>
										全部
									</span>
									<a-alert message="点击图标即可添加，添加完毕后，需手动关闭本界面。" type="info" show-icon
										style="margin-bottom: 10px;"></a-alert>
									

									<template>
										<div style="width: 750px">

											<a-tabs default-active-key="productive" tab-position="left"
												:style="{ height: '600px' }">
												<a-tab-pane v-for="(type, indexType) in allApps" :key="type.name"
													:tab="type.title">

													<a-card :title="type.title" style="padding: 10px;">
														<a-card-grid style="width: 140px;cursor: pointer;"
															v-for="(app, indexApp) in type.apps" class="app"
															@click="addApp(app)">
															<a-avatar shape="square" :size="64" :src="app.icon"
																style="margin-bottom: 10px;"></a-avatar>
															<a-card-meta :title="app.name">
																<template slot="description">
																	{{ app.summary }}
																</template>
															</a-card-meta>
														</a-card-grid>
												</a-tab-pane>
												</a-card>
											</a-tabs>
										</div>
									</template>







								</a-tab-pane>
								<!-- <a-tab-pane key="2">
									<span slot="tab">
										<a-icon type="book"></a-icon>
										从书签创建
									</span>
									待开发
								</a-tab-pane>
								<a-tab-pane key="3">
									<span slot="tab">
										<a-icon type="folder"></a-icon>
										从标签创建
									</span>
									待开发
								</a-tab-pane> -->
								<a-tab-pane key="4">
									<span slot="tab">
										<a-icon type="link"></a-icon>
										从URL创建
									</span>
									<template>
										<a-form :form="form" @submit="handleSubmit">
											<a-alert message="网站的图标不需要设置，当你打开一次这个网站之后，系统就会自动获取并更新。" type="info"
												show-icon style="margin-bottom: 10px;"></a-alert>
											<a-form-item v-bind="formItemLayout" label="应用名">
												<span slot="label">
													应用名&nbsp;
													<a-tooltip title="应用名称">
														<a-icon type="question-circle-o" />
													</a-tooltip>
												</span>
												<a-input placeholder="请输入应用名，少于8个字" v-decorator="[
          'name',
          {
            rules: [{ required: true, message: '请输入应用名！', whitespace: true },{max:8,message:'不得超过8个字！'}],
          },
        ]" />
											</a-form-item>

											<a-form-item v-bind="formItemLayout" label="网址">
												<span slot="label">
													网址&nbsp;
													<a-tooltip title="输入网址，如果不以http://或https://开头，系统会自动加上http://">
														<a-icon type="question-circle-o" />
													</a-tooltip>
												</span>

												<a-auto-complete
													v-decorator="['url', { rules: [{ required: true, message: '请输入网址！' },{max:512,message:'最多不能超过512个字母！'}] }]"
													placeholder="输入任意网址，如http://work.thisky.com，以http或https开头"
													@change="handleWebsiteChange">
													<template slot="dataSource">
														<a-select-option v-for="url in autoCompleteResult" :key="url">
															{{ url }}
														</a-select-option>
													</template>
													<a-input />
												</a-auto-complete>
											</a-form-item>

											<a-form-item v-bind="formItemLayout" label="应用介绍">
												<span slot="label">
													应用介绍&nbsp;
												</span>
												<template>
													<a-textarea placeholder="应用介绍，非必填，不超过100字" :rows="4"
														v-decorator="['summary', { rules: [{max:100,message:'最多不能超过100个字！'}] }]">
													</a-textarea>
												</template>
											</a-form-item>
											<a-form-item :wrapper-col="{ span: 12, offset: 6 }">
												<a-button type="primary" html-type="submit">
													添加
												</a-button>
											</a-form-item>
										</a-form>
									</template>
								</a-tab-pane>
							</a-tabs>
						</template>
					</a-modal>
				</div>
			</template>

		</div>

	</body>
	<template id="sidenavTpl">
		<div>
			<div class="logo">
				<img src="../../icons/icon256.ico" style="width: 32px;height: 32px;">
				应用中心
			</div>
			<a-menu mode="vertical" @click="handleClick" theme="light" :default-selected-keys="['myapp']">
				<a-menu-item key="myapp">
					<a-icon type="user"></a-icon>
					<span>我的应用</span>
				</a-menu-item>
				<a-menu-item key="appstore">
					<a-icon type="appstore"></a-icon>
					<span>应用中心</span>
				</a-menu-item>
			</a-menu>
		</div>
	</template>

	<template id="searchTpl">
		<div class="global-search-wrapper" style="width: 300px">
			<a-auto-complete class="global-search" size="large" style="width: 100%" placeholder="搜索标签、书签、应用、文件"
				option-label-prop="title" @select="onSelect" @search="handleSearch">
				<template slot="dataSource">
					<a-select-option v-for="item in dataSource" :key="item.category" :title="item.category">
						发现 {{ item.query }} 在
						<a :href="`https://s.taobao.com/search?q=${item.query}`" target="_blank"
							rel="noopener noreferrer">
							{{ item.category }}
						</a>
						<span className="global-search-item-count">{{ item.count }} 个结果</span>
					</a-select-option>
				</template>
				<a-input>
					<a-button slot="suffix" style="margin-right: -12px" class="search-btn" size="large" type="primary">
						<a-icon type="search" />
					</a-button>
				</a-input>
			</a-auto-complete>
		</div>
	</template>




	<script src="./sidenav.js"></script>
	<script src="./search.js"></script>
	<script>
		Vue.use(antd)
		Vue.prototype.$form = antd.Form
		var appVue = new Vue({
			el: '#appVue',
			components: {},
			data() {
				return {
					//计算属性，这里加上下划线区分一下
					_myApps: [],
					//定义全部的apps，后期可以改成接口获取
					//_allApps: [], //默认从服务器获取应用列表，如果获取失败，则使用内置的Api

					//左侧导航的数据
					current:'myapp',

					loading: false,
					visible: false,


					//表单验证用字段
					confirmDirty: false,
					//表单自动填充用字段
					autoCompleteResult: [],

					//表单专用填充项目
					name: '',
					url: '',
					summary: '',

					//表单布局用字段
					formItemLayout: {
						labelCol: {
							xs: {
								span: 8
							},
							sm: {
								span: 6
							},
						},
						wrapperCol: {
							xs: {
								span: 24
							},
							sm: {
								span: 16
							},
						},
					},
				}
			},
			beforeCreate() {
				this.form = this.$form.createForm(this, {
					name: 'register'
				});

				if (window.appsData == false && window.loaded) {
					this._myApps = []
					window.appsData = {
						state: {
							myApps: []
						}
					}
					return
				} else {
					this._myApps = window.appsData.state.myApps
				}
			},
			watch: {
				openKeys(val) {
					console.log('openKeys', val);
				},
			},
			computed: {
				myApps: {
					// getter
					get: function() {
						return this._myApps
					},
					// setter
					set: function(newValue) {
						this._myApps = newValue
						window.appsData = {
							state: {
								myApps: newValue
							}
						}
						console.log(window.appsData)
						window.$appsRestore.save()
					}
				},
				allApps: {
					get: function() {
						if (typeof window.$appsApiData == 'undefined' || window.$appsApiData == null) {
							return window.nativeData.allApps
						}
						return window.$appsApiData.allApps
					}
				},
				appUpdateTime: {
					get: function() {
						if (typeof window.$appsApiData == 'undefined' || window.$appsApiData == null) {
							return window.nativeData.updateTime
						} else {
							return window.$appsApiData.updateTime
						}

					}
				}
			},
			methods: {
				getCache(key) {
					//todo 判断是否过期

					if (!window.caches) {
						return false
					} else {
						if (typeof window.caches != 'undefined')
							return window.caches[key]
					}
				},
				setCache(key, value, expire) {

				},
				//添加表单提交数据
				handleSubmit(e) {
					e.preventDefault();
					let that = this
					this.form.validateFieldsAndScroll((err, values) => {
						if (!err) {
							that.myApps.push(values)

							that.$nextTick(() => {
								that.form.resetFields()

							})
						}
					});
				},
				showModal() {
					this.visible = true;
				},
				handleWebsiteChange(value) {
					let autoCompleteResult;
					if (!value) {
						autoCompleteResult = [];
					} else {
						autoCompleteResult = ['.com', '.org', '.net'].map(domain => `${value}${domain}`);
					}
					this.autoCompleteResult = autoCompleteResult;
				},
				handleConfirmBlur(e) {
					const value = e.target.value;
					this.confirmDirty = this.confirmDirty || !!value;
				},
				addApp(app) {
					let that = this
					let have = false
					this.myApps.forEach(function(tApp, index) {
						if (tApp.name == app.name) {
							have = true
						}
					})
					if (have) {
						that.$message.warning('已经添加过' + app.name + '，无需重复添加')
					} else {
						let apps = this.myApps;
						apps.push(app)
						this.myApps = apps
						this.$message.success('添加了应用：' + app.name)
					}

				},
				//添加应用到任务栏
				addTask(app) {
					postMessage({
						message: 'addTask',
						name: app.name,
						url: app.url,
						icon: app.icon
					})
					this.$message.success('成功在左侧栏添加了应用：' + app.name + '。')
				},
				settab(tab){
					this.current=tab
				}

			}
		})
	</script>
	<style>
		.logo {
			height: 32px;
			background: rgba(255, 255, 255, 0.2);
			margin: 16px;
		}

		.trigger {
			font-size: 18px;
			line-height: 64px;
			padding: 0 24px;
			cursor: pointer;
			transition: color 0.3s;
		}

		.trigger:hover {
			color: #1890ff;
		}
	</style>


	<style>
		.global-search-wrapper {
			padding-right: 50px;
			text-align: center;
			display: inline-block;
		}

		.global-search {
			width: 100%;
		}

		.global-search.ant-select-auto-complete .ant-select-selection--single {
			margin-right: -46px;
		}

		.global-search.ant-select-auto-complete .ant-input-affix-wrapper .ant-input:not(:last-child) {
			padding-right: 62px;
		}

		.global-search.ant-select-auto-complete .ant-input-affix-wrapper .ant-input-suffix button {
			border-top-left-radius: 0;
			border-bottom-left-radius: 0;
		}

		.global-search-item {
			display: flex;
		}

		.global-search-item-desc {
			flex: auto;
			text-overflow: ellipsis;
			overflow: hidden;
		}

		.global-search-item-count {
			flex: none;
		}

		.app {
			width: 140px;
			text-align: center
		}

		.ant-modal-header {
			border-bottom: none;
		}

		.ant-modal-body {
			padding-top: 0;
		}

		.ant-card-meta-description {
			font-size: 12px;
			display: -webkit-box;
			-webkit-box-orient: vertical;
			-webkit-line-clamp: 1;
			overflow: hidden;
		}

		.ant-menu-inline,
		.ant-menu-vertical,
		.ant-menu-vertical-left {
			border: none;
		}

		.ant-card {
			background-color: #00000000;
			border: none;
		}

		.ant-card-head {
			border-bottom: none;
		}

		.ant-card-grid {
			box-shadow: none;
		}
	</style>
</html>
